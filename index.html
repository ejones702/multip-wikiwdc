<html>
<meta http-equiv="Cache-Control" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-store" />
<head>
<title>Wiki View Connector</title>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
<script src="https://connectors.tableau.com/libs/tableauwdc-2.0.0-beta.js" type="text/javascript"></script>
<script type="text/javascript">
(function() {
     //
     // Helper functions
     //

     // Takes a ticker symbol, a start date and an end date, and constructs a URL for the Yahoo! stock quote API
     function buildUrl(tickerSymbol) {

         var data = 'https://wikimedia.org/api/rest_v1/metrics/pageviews/per-article/en.wikipedia/all-access/all-agents/'+ tickerSymbol + '/daily/' + '20150101' +'/' + '20170101'
        var url = data;
         return url;
     }

     function getTickersArrayFromConnectionData(connectionData) {
         var tickersArray = connectionData.split(',');

         // Remove whitespace from each ticker string
         return tickersArray.map(function(obj) {
             return obj.trim();
         });
     }

     //
     // Connector definition
     //
     var myConnector = tableau.makeConnector();

     myConnector.getSchema = function(schemaCallback) {
         var tickersArray = getTickersArrayFromConnectionData(tableau.connectionData);

         var schema = [];
         _.forEach(tickersArray, function(ticker) {
           var cols = [
             { id : "views", alias : "views", dataType : tableau.dataTypeEnum.float },
             { id : "article", alias : "article", dataType : tableau.dataTypeEnum.string },
             { id : "agent", alias : "agent", dataType : tableau.dataTypeEnum.string },
             { id : "Date", alias : "Date", dataType : tableau.dataTypeEnum.date },
             { id : "id", alias : "id", dataType : tableau.dataTypeEnum.float }
           ];

            var tableInfo = {
               id : ticker,
               alias : "WikpediaData for " + ticker,
               columns : cols
             };

             schema.push(tableInfo);
         });

         schemaCallback(schema); // tell tableau about the fields and their types
     };



     myConnector.getData = function(table, doneCallback) {


       tableau.log(table.tableInfo.id);


         var ticker = table.tableInfo.id;

         var connectionUrl = buildUrl(ticker);
         var APIPromise = makeAPIRequest(table, ticker, connectionUrl); // Key and ticker are the same

         APIPromise.then(function(response) {
             console.log("Success");
             doneCallback();
         }, function(error) {
             console.error(error);
         });
     };

     function makeAPIRequest(table, ticker, connectionUrl) {
         return new Promise(function(resolve, reject) {
             var xhr = $.ajax({
                 url: connectionUrl,
                 dataType: 'json',
                 success: function(data) {
                     if (data) {
                         var quotes = data.items;
                         var ii;
                         var toRet = [];
                         // mash the data into an array of objects
                         for (ii = 0; ii < quotes.length; ++ii) {
                             // Each entry can be a list of values in the same order as the columns
                             // var entry = [quotes[ii].Symbol, quotes[ii].Date, quotes[ii].Close];
                             // or an object where the column ids are the keys of the map
                             /*var entry = {
                                 'ticker': quotes[ii].Symbol,
                                 'day': quotes[ii].Date,
                                 'close': quotes[ii].Close
                             };*/
                             var entry = [quotes[ii].views, quotes[ii].article, quotes[ii].agent, quotes[ii].timestamp.slice(4,6)+"/"+quotes[ii].timestamp.slice(6,8)+"/"+quotes[ii].timestamp.slice(0,4) ];
                             toRet.push(entry);
                         }

                         table.appendRows(toRet);
                         resolve();
                     } else {
                         Promise.reject("No results found for ticker symbol: " + ticker);
                     }
                 },
                 error: function(xhr, ajaxOptions, thrownError) {
                     Promise.reject("error connecting to the yahoo stock data source: " + thrownError);
                 }
             });
         });
     }

     setupConnector = function() {
         var tickersString = $('#tickers').val().trim();
         if (tickersString) {
             tableau.connectionData = tickersString; // set the ticker symbol as the connection data so we can get to it when we fetch the data
             tableau.connectionName = 'Wiki Views: ' + tickersString; // name the data source. This will be the data source name in Tableau
             tableau.submit();
         }
     };

     tableau.registerConnector(myConnector);

     //
     // Setup connector UI
     //
     $(document).ready(function() {
         $("#submitButton").click(function() { // This event fires when a button is clicked
             setupConnector();
         });
         $('#tickerForm').submit(function(event) {
             event.preventDefault();
             setupConnector();
         });
     });
 })();

</script>

</head>
<body>
  <div class="container container-table">
    <div class="row vertical-center-row">
       <div class="text-center col-md-4 col-md-offset-4"">
        <form role="form" id="tickerForm" autocomplete="off">
          <div class="form-group" style="margin: 10px;">
            <input type="text" id="tickers" class="form-control" id="name" placeholder="Enter Multiple Wiki Articles Separated by Commas">
            <button type="button" id="submitButton" class="btn btn-success" style="margin: 10px;">Get View Data</button>
          </div>
        </form>
       </div>
    </div>
  </div>
</body>
</html>
